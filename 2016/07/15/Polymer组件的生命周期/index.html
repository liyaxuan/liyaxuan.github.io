<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Polymer组件的生命周期 · Hexo</title><meta name="description" content="Polymer组件的生命周期 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Hexo"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Polymer组件的生命周期</h1><div class="post-info">Jul 15, 2016</div><div class="post-content"><h2 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h2><p>Polymer为每个组件提供了一些生命周期钩子函数，这些钩子函数在组件被创建、插入到DOM树的时候调用。开发者可以在组件上注册这些钩子函数，并写一些建立数据监测、事件监听的初始化逻辑。钩子中的this都指向当前element。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dom-module</span> <span class="attr">id</span>=<span class="string">"wx-inner"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line">        var WxInner = Polymer(&#123;</div><div class="line">            is: 'wx-inner',</div><div class="line">            created: function () &#123;</div><div class="line">                // this refer to the element instance</div><div class="line">                console.log('wx-inner created');</div><div class="line">            &#125;,</div><div class="line">            ready: function () &#123;</div><div class="line">                // this refer to the element instance</div><div class="line">                console.log('wx-inner ready');</div><div class="line">            &#125;,</div><div class="line">            factoryImpl: function (a, b, c) &#123;</div><div class="line">                // this refer to the element instance</div><div class="line">                this.a = a;</div><div class="line">                this.b = b;</div><div class="line">                this.c = c;</div><div class="line">                console.log('wx-inner factoryImpl');</div><div class="line">            &#125;,</div><div class="line">            attached: function () &#123;</div><div class="line">                // this refer to the element instance</div><div class="line">                console.log('wx-inner attached');</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dom-module</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>created</code>、<code>ready</code>、<code>attached</code>这三个钩子函数从字面意思上都很好理解，但是<code>factoryImpl</code>是做什么的呢？回答这个问题要先说一下构造组件的两种方法，createElement()和构造函数，以上面这段代码中的<code>wx-inner</code>为例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> wxInner = <span class="built_in">document</span>.createElement(<span class="string">'wx-inner'</span>); <span class="comment">// output: wx-inner created, wx-inner ready</span></div><div class="line"><span class="comment">// or var wxInner = new WxInner(1, 2, 3); output: wx-inner created, wx-inner ready, wx-inner factoryImpl</span></div><div class="line"><span class="keyword">this</span>.root.appendChild(wxInner); <span class="comment">// output: wx-inner attached</span></div></pre></td></tr></table></figure></p>
<p>也就是说，用createElement()和构造函数创建组件都会调用<code>created</code>和<code>ready</code>，但是<code>factoryImpl</code>只会在使用构造函数创建组件的时候调用。这里引用官方文档。</p>
<blockquote>
<p>The factoryImpl method is only invoked when you create an element using the constructor</p>
</blockquote>
<p>在这个例子中，<code>new WxInner(1, 2,3)</code>会在组件实例上添加<code>a</code>、<code>b</code>、<code>c</code>三个属性。注意，是直接作用在实例上，而不是实例的<code>properties</code>上。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">console</span>.log(wxInner.a); <span class="comment">// 1</span></div><div class="line"><span class="built_in">console</span>.log(wxInner.b); <span class="comment">// 2</span></div><div class="line"><span class="built_in">console</span>.log(wxInner.c); <span class="comment">// 3</span></div><div class="line"><span class="built_in">console</span>.log(wxInner.properties.a); <span class="comment">//undefined</span></div></pre></td></tr></table></figure></p>
<h2 id="全局污染"><a href="#全局污染" class="headerlink" title="全局污染"></a>全局污染</h2><p>我之前一直以为Polymer会把<code>&lt;script&gt;&lt;/script&gt;</code>中的JS代码放到一个闭包里去执行，然后按照<code>is</code>属性把<code>Polymer()</code>返回的组件构造函数注册到一个全局对象上。然而刚刚做了个测试，惊讶地发现这就是一个全局作用域。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- wx-outer --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dom-module</span> <span class="attr">is</span>=<span class="string">"wx-outer"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">wx-inner</span>&gt;</span><span class="tag">&lt;/<span class="name">wx-inner</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">        <span class="keyword">var</span> wxg = <span class="string">'wexin group outer'</span>;</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span>   </div><div class="line"><span class="tag">&lt;/<span class="name">dom-module</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- wx-inner --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dom-module</span> <span class="attr">is</span>=<span class="string">"wx-inner"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">        <span class="keyword">var</span> wxg = <span class="string">'wexin group inner'</span>;</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dom-module</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>console.log(wxg)</code>输出<code>wxg</code>的值，是<code>wexin group outer</code>。<code>wx-outer</code>中的代码覆盖了<code>wx-inner</code>中的代码（至于这个覆盖顺序是怎样的，会在下面阐述）。所以最好不要在<code>&lt;script&gt;&lt;/script&gt;</code>中定义变量，容易引起冲突。可以采用下面的写法，避免全局污染。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">    <span class="comment">// recommended</span></div><div class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">window</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">        <span class="built_in">window</span>.WxInner = Polymer(&#123;</div><div class="line">            is: <span class="string">'wx-inner'</span>,</div><div class="line">            <span class="comment">// other config</span></div><div class="line">        &#125;);</div><div class="line">    &#125;)(<span class="built_in">window</span>);</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="初始化时序"><a href="#初始化时序" class="headerlink" title="初始化时序"></a>初始化时序</h2><p>这里引用官方文档，一个组件的初始化时序如下：</p>
<ol>
<li>created callback.</li>
<li>Local DOM initialized</li>
<li>ready callback</li>
<li>factoryImpl callback</li>
<li>attached callback  </li>
</ol>
<p>在<code>created</code>和<code>ready</code>这两个时间点之间，当前组件在做初始化local DOM的工作。这里是官方文档对local DOM initialized的解释。</p>
<blockquote>
<p>This means that local DOM children are created, their property values are set as specified in the template, and ready has been called on them</p>
</blockquote>
<p>其中，<code>1</code> <code>2</code> <code>3</code> <code>4</code>发生在组件创建的过程中，<code>5</code>发生在组件被插入到DOM树的时。对于单个组件，这个顺序很好理解，也很自然。但是如果像下面这样，存在存在组件嵌套的时候，各个组件的钩子函数又是按怎样的顺序调用的呢？<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">wx-a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">wx-b</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">wx-c</span>&gt;</span><span class="tag">&lt;/<span class="name">wx-c</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">wx-b</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">wx-a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>我编写了三个结构相似的组件，<code>&lt;wx-a&gt;&lt;/wx-a&gt;</code>、<code>&lt;wx-b&gt;&lt;/wx-b&gt;</code>和<code>&lt;wx-c&gt;&lt;/wx-c&gt;</code>。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- wx-a --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"import"</span> <span class="attr">href</span>=<span class="string">"wx-b.html"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dom-module</span> <span class="attr">id</span>=<span class="string">"wx-a"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>a<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">wx-b</span>&gt;</span><span class="tag">&lt;/<span class="name">wx-b</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">    Polymer(&#123;</div><div class="line">      is: <span class="string">'wx-a'</span>,</div><div class="line">      created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'a is created'</span>);</div><div class="line">      &#125;,</div><div class="line">      ready: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'a is ready'</span>);</div><div class="line">      &#125;,</div><div class="line">      attached: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'a is attached'</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dom-module</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- wx-b --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"import"</span> <span class="attr">href</span>=<span class="string">"wx-c.html"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dom-module</span> <span class="attr">id</span>=<span class="string">"wx-b"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>It's b<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">wx-c</span>&gt;</span><span class="tag">&lt;/<span class="name">wx-c</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">    Polymer(&#123;</div><div class="line">      is: <span class="string">'wx-b'</span>,</div><div class="line">      created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'b is created'</span>);</div><div class="line">      &#125;,</div><div class="line">      ready: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'b is ready'</span>);</div><div class="line">      &#125;,</div><div class="line">      attached: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'b is attached'</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dom-module</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- wx-c --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dom-module</span> <span class="attr">id</span>=<span class="string">"wx-c"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>It's c<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">    Polymer(&#123;</div><div class="line">      is: <span class="string">'wx-c'</span>,</div><div class="line">      created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'c is created'</span>);</div><div class="line">      &#125;,</div><div class="line">      ready: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'c is ready'</span>);</div><div class="line">      &#125;,</div><div class="line">      attached: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'c is attached'</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dom-module</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>输出如下。为了方便理解，这里加了缩进和注释。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">a is created</div><div class="line">    <span class="comment">// wx-a's local DOM initializing</span></div><div class="line">    b is created</div><div class="line">        <span class="comment">// wx-b's local DOM initializing</span></div><div class="line">        c is created</div><div class="line">            <span class="comment">// wx-c's local DOM initializing</span></div><div class="line">            <span class="comment">// ······</span></div><div class="line">            <span class="comment">// wx-c's local DOM initialized</span></div><div class="line">        c is ready</div><div class="line">        <span class="comment">// wx-b's local DOM initialized</span></div><div class="line">    b is ready</div><div class="line">    <span class="comment">// wx-a's local DOM initialized</span></div><div class="line">a is ready</div><div class="line"></div><div class="line">        c is attached</div><div class="line">    b is attached</div><div class="line">a is attached</div></pre></td></tr></table></figure></p>
<p>所以，创建组件其实是一个递归的过程。</p>
<ul>
<li>外层组件<code>created</code>，才会create内层组件。</li>
<li>内层组件全部<code>ready</code>，外层组件才会<code>ready</code>。</li>
<li>内层组件全部<code>attached</code>，外层组件才会<code>attached</code>。</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/07/15/Polymer数据绑定/" class="prev">上一篇</a><a href="/2016/07/12/hello-world/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://yoursite.com">John Doe</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>